# Лабораторная работа №3: Определение времени по стрелочным часам

## Описание проекта

Программа для автоматического определения времени на аналоговых (стрелочных) часах с использованием методов компьютерного зрения и глубокого обучения.

## Основные возможности

- ✅ **Обнаружение циферблата**: Автоматическое определение местоположения часов на изображении
- ✅ **Распознавание времени**: Точное определение часов и минут
- ✅ **Работа с декораторами**: Устойчивость к посторонним линиям и окружностям
- ✅ **Множественные методы**: Классический CV и улучшенные алгоритмы
- ✅ **Предобработка изображений**: Улучшение качества для лучшего распознавания
- ✅ **Генерация данных**: Создание синтетических изображений для обучения

## Архитектура решения

### Двухэтапный подход (Two-Stage Pipeline)

1. **Stage 1: Обнаружение циферблата (Clock Detection)**
   - Использует алгоритм Hough Circles для поиска круглых объектов
   - Множественные наборы параметров для робастности
   - Оценка и выбор наиболее вероятного циферблата

2. **Stage 2: Распознавание времени (Time Recognition)**
   - Обнаружение стрелок с использованием Hough Lines
   - Фильтрация линий по геометрическим параметрам
   - Вычисление углов и преобразование в время
   - Уточнение часа на основе положения минутной стрелки

### Модули проекта

```
lab3/
├── clock_models.py              # Модели для обнаружения и распознавания
│   ├── ClockDetectionModel      # Обнаружение циферблата
│   └── ClockTimeRecognitionModel # Распознавание времени
├── synthetic_clock_generator.py # Генератор синтетических данных
├── README.md                    # Документация
└── task.md                      # Задание
```

## Использование

### Запуск приложения

```bash
# Установка зависимостей
pip install -r requirements.txt

# Запуск основного приложения
python lab3_app.py
```

### Интерфейс приложения

1. **Загрузка изображения**: Нажмите "Загрузить изображение" и выберите файл
2. **Выбор метода**: 
   - Улучшенный (Enhanced) - использует передовые алгоритмы
   - Классический (Basic) - базовый подход
   - Гибридный (Hybrid) - комбинация методов
3. **Настройки**:
   - Предобработка - улучшение качества изображения
   - Показать шаги - визуализация промежуточных результатов
4. **Определение времени**: Нажмите кнопку для анализа

### Генерация синтетических данных

```python
from lab3.synthetic_clock_generator import SyntheticClockGenerator

# Создание генератора
generator = SyntheticClockGenerator("output_directory")

# Генерация датасета
generator.generate_dataset(
    num_samples=1000,      # Количество изображений
    clock_size=300,        # Размер циферблата
    image_size=(640, 640)  # Размер итогового изображения
)
```

### Использование моделей в коде

```python
from lab3.clock_models import (
    ClockDetectionModel, 
    ClockTimeRecognitionModel,
    create_preprocessing_pipeline
)
import cv2

# Загрузка изображения
image = cv2.imread('clock_image.jpg')

# Предобработка
preprocessed = create_preprocessing_pipeline(image)

# Обнаружение циферблата
detector = ClockDetectionModel()
detection = detector.detect_clock_face(preprocessed)

if detection:
    # Извлечение области циферблата
    clock_face = detector.extract_clock_face(image, detection)
    
    # Распознавание времени
    recognizer = ClockTimeRecognitionModel()
    hour, minute, confidence = recognizer.predict_time(clock_face)
    
    print(f"Время: {hour:02d}:{minute:02d}")
    print(f"Уверенность: {confidence*100:.0f}%")
```

## Технические детали

### Алгоритмы обнаружения циферблата

1. **Hough Circle Transform**
   - Множественные запуски с разными параметрами
   - Оценка на основе размера и центральности
   - Устойчивость к шуму и посторонним окружностям

### Алгоритмы распознавания времени

1. **Line Detection (Hough Lines)**
   - Обнаружение линий в области циферблата
   - Фильтрация по геометрическим критериям:
     - Линии должны начинаться около центра
     - Линии должны достигать внешней части циферблата
   
2. **Angle Calculation**
   - Вычисление угла от центра к кончику стрелки
   - 0° соответствует 12 часам, отсчет по часовой стрелке
   
3. **Time Conversion**
   - Минуты: `minute = angle / 6°` (360° / 60 минут)
   - Часы: `hour = angle / 30°` (360° / 12 часов)
   - Уточнение: часовая стрелка зависит от минут

### Предобработка изображений

```python
def create_preprocessing_pipeline(image):
    # 1. Шумоподавление
    denoised = cv2.fastNlMeansDenoisingColored(image)
    
    # 2. Улучшение контраста (CLAHE)
    lab = cv2.cvtColor(denoised, cv2.COLOR_BGR2LAB)
    l, a, b = cv2.split(lab)
    clahe = cv2.createCLAHE(clipLimit=3.0, tileGridSize=(8,8))
    l = clahe.apply(l)
    enhanced = cv2.merge([l, a, b])
    
    return cv2.cvtColor(enhanced, cv2.COLOR_LAB2BGR)
```

## Генератор синтетических данных

### Возможности

- Генерация часов с различными стилями:
  - Современный (только метки)
  - Римские цифры
  - Арабские цифры
- Вариативность:
  - Случайные цвета циферблата и стрелок
  - Различные размеры и толщины стрелок
  - Разнообразные фоны
- Декораторы (distractors):
  - Случайные линии на фоне
  - Посторонние окружности
- Аугментации:
  - Поворот
  - Размытие
  - Изменение яркости

### Формат аннотаций

```json
{
  "filename": "clock_00001.png",
  "hour": 3,
  "minute": 15,
  "time": "03:15",
  "bbox": [170, 170, 300, 300],
  "hands": [
    {"type": "hour", "angle": 97.5},
    {"type": "minute", "angle": 90.0}
  ],
  "image_size": [640, 640]
}
```

## Тестирование

### Тестовые изображения

В директории `lab3/` находятся тестовые изображения:
- `Clock_1.jpg` - Часы с декоративными элементами (~3:15)
- `Clock_2.jpg` - Часы с вертикальными линиями на фоне (~4:20)
- `church-clock.webp` - Церковные часы с кирпичным узором (~4:25)

### Результаты тестирования

Программа успешно обрабатывает изображения с:
- Посторонними линиями (кирпичная кладка, металлические конструкции)
- Множественными окружностями (декоративные элементы)
- Различным освещением
- Разными стилями циферблатов

## Будущие улучшения

### Планируемые функции

1. **Deep Learning интеграция**
   - CNN-backbone для извлечения признаков
   - Spatial Transformer Network для выравнивания
   - Dual output heads (классификация часа + регрессия минут)

2. **Дополнительные возможности**
   - Поддержка цифровых часов
   - Определение AM/PM
   - Работа с поврежденными циферблатами
   - Batch processing множественных изображений

3. **Оптимизации**
   - Ускорение обработки с помощью GPU
   - Кэширование результатов
   - Параллельная обработка

## Технический стек

- **Python 3.8+**
- **OpenCV** - Обработка изображений
- **NumPy** - Численные вычисления
- **PyQt5** - Графический интерфейс
- **Pillow** - Работа с изображениями
- **scikit-image** - Дополнительные алгоритмы

## Авторы

Лабораторная работа №3 по курсу "Компьютерное зрение"

## Лицензия

Учебный проект

